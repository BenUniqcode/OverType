<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"> 
		<title>Ben's Super-Realistic Typewriter Simulator</title>
		<style type="text/css" media="all">
			body {
				font-family: Helvetica, sans-serif;
				font-size: 10pt;
				background-color: #eee;
			}
			h2 {
				font-size: 12pt;
			}
			h3 {
				font-size: 11pt;
			}
			#input {
				position: absolute;
				left: -1000px;
				top: -1000px;
			}
			.instruct {
				font-size: 20pt;
				color: #666;
			}
			.output {
				font-family: Courier, "Courier New", monospace;
				font-size: 20px;
				line-height: 30px;
				position: absolute;
				left: 5em;
				top: 3em;
				margin-bottom: 2em;
				width: 50em;
				height: 120ex;
				background-color: white;
				border: 1px solid black;
				padding: 8ex 2em;
				box-shadow: 8px 8px 4px #888;
				display: none;
			}
			.cursor {
				position: absolute;
				z-index: 999;
				width: 10px;
				height: 2px;
				background-color: red;
				display: none;
			}
		</style>
		<style type="text/css" media="print">
			.cursor, .title, .instruct, #input { display: none }
			.output { left: 0 !important; top: 0 !important; box-shadow: none; border: none; padding: 10ex 0 0 0; }			
		</style>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script type="text/javascript">window.jQuery || document.write( '<script type="text/javascript" src="assets/ion_sound_1.3.0/js/vendor/jquery-1.10.2.min.js"><\/script>' )</script>
		<script type="text/javascript" src="assets/ion_sound_1.3.0/js/ion-sound/ion.sound.min.js"></script>
		<script type="text/javascript">
			const bell_width = 69;
			const max_width = 80;
			const tab_width = 8;
			const ribbon_lifetime = 800;
			const colour_variation = 75;
			const unshifted = {
			   59: ';',
				 61: '=',
				173: '-',
				188: ',',
				190: '.',
				191: '/',
				192: '`',
				219: '[',
				220: '\\',
				221: ']',
				222: '\'',
			};
			const shifted = {
				48: ')',
				49: '!',
				50: '@',
				51: 'Â£',
				52: '$',
				53: '%',
				54: '^',
				55: '&',
				56: '*',
				57: '(',
				59: ':',
				61: '+',
				173: '_',
				188: '<',
				190: '>',
				191: '?',
				192: '~',
				219: '{',
				220: '|',
				221: '}',
				222: '"',
			};
			const xpx = 12, ypx = 30;
			var x = 0, y = 0, backspaces = 0;
			var vmid = $(window).height() / 2;
			var hmid = $(window).width() / 2;
			var voffset = {};
			var keydown_mutex = false;
			var shift_mutex = false;
			var chars_typed = 0;
			
			function handle_keypress(e) {
				$('.info').hide();
				$('.output').show();
				$('.cursor').show();
				key = e.which;
				if (key == 16) { // shift
					if (shift_mutex) {
						return false;
					}
					$.ionSound.play('typewriter-spacebar');
					shift_mutex = true;
					return false;
				} 
				if (keydown_mutex) {
					return false;
				}
				keydown_mutex = true;
				if (key == 13) { // enter
					e.preventDefault();
					$.ionSound.play('typewriter-carriage-return');
					$('.output').append('<br/>');
					line_length = x;
					x = 0;
					backspaces = 0;
					y++;
					return_time = 13 * line_length;
					$('.output').animate({
						top: (vmid - (y * ypx)) + 'px',
					}, 100).animate({
						left: (hmid - (x * xpx)) + 'px',
					}, return_time, function() {
						// Stop playing the sound when the animation completes
						$.ionSound.stop('typewriter-carriage-return');
					}); 
					return false;
				}
				if (key == 8) { // backspace
					if (x > 1) {
						x--;
						backspaces++;
						$.ionSound.play('typewriter-spacebar');
					} 
					return false;
				} 
				if (key == 9) { // tab
					e.preventDefault(); // Don't lose focus
					$.ionSound.play('typewriter-spacebar');
					if (e.shiftKey) {
						var prev_tab_stop = (x % tab_width);
						if (prev_tab_stop == 0) {
							prev_tab_stop = tab_width;
						} 
						if (x - prev_tab_stop < 0) {
							prev_tab_stop = x;
						}
						x -= prev_tab_stop; 
						backspaces += prev_tab_stop;
					} else {
						var next_tab_stop = tab_width - (x % tab_width);
						if (next_tab_stop == 0) {
							next_tab_stop = tab_width;
						} else if (x + next_tab_stop > max_width) {
							next_tab_stop = max_width - x;
						}
						x += next_tab_stop;
						char = Array(next_tab_stop + 1).join('&nbsp;');
						$('.output').append('<span style="position: relative; left: -' + (backspaces * 0.6) + 'em;">' + char + '</span>');
					}
					move_page();
					return false;
				}
				if (key == 32) { // space
					$.ionSound.play('typewriter-spacebar');
				} else if (x == bell_width) {
					$.ionSound.play('typewriter-bell-2');
				} else {
					$.ionSound.play('typewriter-keydown');
				}
				var c = String.fromCharCode(key);
				if (e.shiftKey) {
					if (c.match(/[A-Za-z]/)) {
						c = c.toUpperCase();
						chars_typed++;
					} else if (shifted[key]) {
						c = shifted[key];
						chars_typed++;
					} else {
						c = '&nbsp;';
					}
				} else if (c.match(/[A-Za-z0-9]/)) {
					c = c.toLowerCase();
					chars_typed++;
				} else if (unshifted[key]) {
					c = unshifted[key];
					chars_typed++;
				} else {
					c = '&nbsp;';
				}
				
				// Choose a greyscale colour with a random element to simulate uneven key pressure and ribbon ink
				var ink_depletion = Math.round(255 * (chars_typed / ribbon_lifetime));
				var greylevel = Math.floor((Math.random() * colour_variation)) + ink_depletion;
				var color = 'rgb(' + greylevel + ',' + greylevel + ',' + greylevel + ')';
				
				// Vertical offset
				if (! (c in voffset)) {
					voffset[c] = Math.round((Math.random() * 2.0) - 1.0);
				}
				
				// Output the character
				$('.output').append('<span style="position: relative; top: ' + voffset[c] + 'px; left: -' + (backspaces * 0.6) + 'em; color: ' + color + ';">' + c + '</span>');
				
				if (x < max_width) {
					x++;
				} else {
					backspaces++; // Fudge hard right margin without position:absolute
				}
				return false;
			}
			
			function move_page() {
				$('.output').animate({
					top: (vmid - (y * ypx)) + 'px',
					left: (hmid - (x * xpx)) + 'px',
				}, 20);
			}

			$(function() {
				move_page();
				$('.cursor').css('top', vmid + ypx + 70).css('left', hmid + 43);
				$.ionSound({
					path: "assets/typewriter_sounds/",
    			sounds: [
        		"typewriter-keydown",
        		"typewriter-keyup",
        		"typewriter-carriage-return",
        		"typewriter-spacebar",
        		"typewriter-bell-2",
    			],
    			multiPlay: true,
				});
				$('#input').val('').trigger('focus')
				.on('blur', function(e) { 
				  // A small delay seems to be necessary before forcing the focus back
				  e.preventDefault();
					setTimeout(function() {
						$('#input').trigger('focus'); 
					}, 20); 
				})
				.on('keydown', function(e) { // I originally used keypress, but this ignores backspace on Chrome
					handle_keypress(e); 
				})
				.on('keyup', function(e) {
					if (keydown_mutex && e.which != 16) {
						// Play the key release sound after a short delay
						setTimeout(function() {
							$.ionSound.play('typewriter-keyup');
						}, 65);
						move_page();
						// Wait till all animations have finished before releasing the mutex
						$(":animated").promise().done(function() {
							keydown_mutex = false;
						});
					} else if (shift_mutex && e.which == 16 && ! e.shiftKey) {
						$.ionSound.play('typewriter-keyup');
						shift_mutex = false;
					}						
				}); // on()
			}); //$()
		</script>
	</head>
	<body>
		<textarea id="input">
		</textarea>
		<div class="title">
			<h1 style="margin-bottom: 0">Ben's Super-Realistic* Typewriter Simulator</h1>
			<p style="margin-top: 0"><small>* Neither realism nor superness guaranteed</small></p>
		</div>
		<div class="info">
			<h2>
				Why?
			</h2>
			<p>
				All the existing typewriter simulators that I've found on the web get one very basic thing wrong - when you press backspace, they erase the character you just typed, just like a computer. On a real typewriter, backspace
				simply moves the carriage back one space, allowing you to overtype a previously typed character; so I have implemented
				it this way. If you want to erase a character, you need Tipp-Ex. (NB I do not advise using Tipp-Ex on your monitor). 
			</p>
			<h2>
				Yeah, but... WHY?
			</h2>
			<p>
				Because it's a fun thing to play with and also an interesting little development project - there's more of a challenge to the implementation than you might expect...
			</p>
			<noscript>
				<p style="font-size: 36px">
					<b>You need to <a href="http://enable-javascript.com">enable Javascript in your browser</a> for this to work.</b>
				</p>
			</noscript>
			<h2>Instructions</h2>
			<div class="instruct">
				<ul>
				<li>Make sure you have your sound turned on for the fully-immersive experience!</li>
				<li>Just start typing (all this informational text will disappear to give you more space).</li>
				<li>If it stops working or to see this text again, just reload the page.</li>
				</ul>
			</div>
			<h2>
				Improvements I'd like to make
			</h2>
			<ul>
				<li>If you type too fast or try to type two keys at once, the mechanism should jam.</li>
				<li>User-adjustable settings for things like ribbon wear and wibbly-wobbliness.</li>
				<li>Further suggestions welcome (though remember this is just for fun!) to <a href="mailto:ben@uniqcode.com">ben@uniqcode.com</a></li>
			</ul>
			<h2>
				Credits
			</h2>
			<p>
				Dedicated to Archie. Developed by Ben Wheeler @ <a href="http://uniqcode.com">UniqCode</a>, using <a href="http://jquery.com">jQuery</a> and
				<a href="https://github.com/IonDen/ion.sound">IonSound</a>. Typewriter sound effects from <a href="http://freesound.org">Freesound</a> and <a href="http://www.soundjay.com">SoundJay</a>, some of them edited by me. Tested on Firefox27/Mac and Chrome32/Mac. 			
			</p>
			<h2>
				Changelog
			</h2>
			<div class="changelog">
				<h3>
					version 1.10 (2014-02-11)
				</h3>
				<ul>
					<li>fix CSS font-family (whoops)</li>
					<li>per-char vertical offset was not being used consistently</li>
				</ul>		
				<h3>
					version 1.9 (2014-02-11)
				</h3>
				<ul>
					<li>Stylesheet for printing</li>
					<li>Increased space between lines</li>
				</ul>
				<h3>
					version 1.8 (2014-02-11)
				</h3>
				<ul>
					<li>The ribbon ink now gradually runs out, so the text becomes lighter the more characters you type.</li>
					<li>Reduced vertical offset, as it was just a tad too wibbly-wobbly.</li>
				</ul>
				<h3>
					version 1.7 (2014-02-11)
				</h3>
				<ul>
					<li>Prevent the hidden textarea from losing focus. It should now be safe to click anywhere on the page.</li>
					<li>Implemented tab stops every 8 chars - press TAB to jump to the next tab stop, SHIFT-TAB jumps to the previous one.</li>
				</ul>
				<h3>
					version 1.6 (2014-02-11)
				</h3>
				<ul>
					<li>If both shift keys are pressed, don't do the keyup sound until both are released.</li>
					<li>Round the vertical offset to an integer number of pixels.</li>
					<li>Don't release the keydown mutex until animations have finished. This limits typing speed and prevents being able to type a character onto the next line while a carriage return is in progress.</li>
				</ul>
				<h3>
					version 1.5 (2014-02-11)
				</h3>
				<ul>
					<li>Use a separate mutex for the shift key.</li>
					<li>Position the page on load so it doesn't jump after the first keypress.</li>
				</ul>
				<h3>
					version 1.4 (2014-02-11)
				</h3>
				<ul>
					<li>Move paper on keyup, not keydown.</li>
					<li>Use a mutex to ensure only one keypress is handled at a time, instead of a timeout (also fixes a long-held key generating two characters).</li>
					<li>Each character now has a consistent vertical offset (randomly chosen at the start), instead of randomly changing each time.</li>
					<li>Drop shadow on page.</li>
					<li>Fix page moving too far vertically on CR.</li>
				</ul>
				<h3>
					version 1.3 (2014-02-10)
				</h3>
				<ul>
					<li>The typed character now always appears in the centre of the screen; the "paper" moves.
		Movement of paper and carriage return are animated.</li>
					<li>A basic cursor to show where the next character will appear. This could eventually become an animated print head.</li>
					<li>Wibbly-wobbly text: A small random vertical offset is added to each character (suggested by David Gosnell)</li>
				</ul>

				<h3>
					version 1.2 (2014-02-10)
				</h3>
				<ul>
					<li>Don't allow backspacing past the beginning of the line.</li>
				</ul>
				<h3>
					version 1.1 (2014-02-10)
				</h3>
				<ul>
					<li>Separate sounds when keys are pressed and released, and for the shift key.</li>
					<li>Better (manual) carriage return sound.</li>
					<li>Limit the speed at which you can type.</li>
					<li>If you keep typing past the bell and hit the end of the line (80 characters), the carriage stops instead of continuing. In other words there is now a hard line length limit.</li>
					<li>Punctuation characters are handled (these are based on my UK Mac keyboard; unless you have the same keyboard some characters will probably be "wrong" for you.).</li>
					<li>Random variation of colour to simulate variations in key pressure and uneven ribbon ink.</li>
					<li>Hide all the informational text when you start typing, partly to give more space for both information and typing, but mostly to dodge the problem of trying to work out where to position the typewriter output so it doesn't crash the info.</li>
				</ul>
				<h3>
					version 1.0 (2014-02-09)
				</h3>
			</div><!-- /changelog -->			
		</div>
		<div class="output">
		</div>
		<div class="cursor">
		</div>
	</body>
</html>