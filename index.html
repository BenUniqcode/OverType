<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"> 
		<title>Ben's Super-Realistic Typewriter Simulator</title>
		<style type="text/css">
			body {
				font-family: Helvetica, sans-serif;
				font-size: 10pt;
			}
			h2 {
				font-size: 12pt;
			}
			h3 {
				font-size: 11pt;
			}
			.input {
				position: absolute;
				left: -1000px;
				top: -1000px;
			}
			.instruct {
				font-size: 20pt;
				color: #666;
			}
			.output {
				font-family: Courier, Courier New, fixed;
				font-size: 20px;
				position: absolute;
				left: 5em;
				top: 3em;
				border: 1px solid black;
				margin-bottom: 2em;
				padding: 8ex 2em;
				width: 50em;
				height: 80ex;
				display: none;
			}
			.cursor {
				position: absolute;
				z-index: 999;
				width: 10px;
				height: 2px;
				background-color: black;
				display: none;
			}
		</style>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script type="text/javascript">window.jQuery || document.write( '<script type="text/javascript" src="assets/ion_sound_1.3.0/js/vendor/jquery-1.10.2.min.js"><\/script>' )</script>
		<script type="text/javascript" src="assets/ion_sound_1.3.0/js/ion-sound/ion.sound.min.js"></script>
		<script type="text/javascript">
			const bell_width = 69;
			const max_width = 80;
			const colour_variation = 90;
			const unshifted = {
			   59: ';',
				 61: '=',
				173: '-',
				188: ',',
				190: '.',
				191: '/',
				192: '`',
				219: '[',
				220: '\\',
				221: ']',
				222: '\'',
			};
			const shifted = {
				48: ')',
				49: '!',
				50: '@',
				51: 'Â£',
				52: '$',
				53: '%',
				54: '^',
				55: '&',
				56: '*',
				57: '(',
				59: ':',
				61: '+',
				173: '_',
				188: '<',
				190: '>',
				191: '?',
				192: '~',
				219: '{',
				220: '|',
				221: '}',
				222: '"',
			};
			var x = 1, y = 3, backspaces = 0;
			var timeout;
			var vmid = $(window).height() / 2;
			var hmid = $(window).width() / 2;
			function handle_keypress(e) {
				$('.info').hide();
				$('.output').show();
				$('.cursor').show();
				key = e.which;
				if (key == 13) { // enter
					e.preventDefault();
					$.ionSound.play('typewriter-carriage-return');
					$('.output').append('<br/>');
					line_length = x;
					x = 1;
					backspaces = 0;
					y++;
					return_time = 13 * line_length;
					$('.output').animate({
						top: (vmid - (y * 24)) + 'px',
					}, 100).animate({
						left: (hmid - (x * 12)) + 'px',
					}, return_time, function() {
						$.ionSound.stop('typewriter-carriage-return');
					}); // Stop playing the sound when the animation completes
				} else if (key == 16) { // shift
					$.ionSound.play('typewriter-spacebar');
				} else {
					if (key == 8) { // backspace
						if (x > 1) {
							x--;
							backspaces++;
							$.ionSound.play('typewriter-spacebar');
						}
					} else {
						if (key == 32) { // space
							$.ionSound.play('typewriter-spacebar');
						} else if (x == bell_width) {
							$.ionSound.play('typewriter-bell-2');
						} else {
							$.ionSound.play('typewriter-keydown');
						}
						var char = String.fromCharCode(key);
						if (e.shiftKey) {
							if (char.match(/[A-Za-z]/)) {
								char = char.toUpperCase();
							} else if (shifted[key]) {
								char = shifted[key];
							} else {
								char = '&nbsp;';
							}
						} else if (char.match(/[A-Za-z0-9]/)) {
							char = char.toLowerCase();
						} else if (unshifted[key]) {
							char = unshifted[key];
						} else {
							char = '&nbsp;';
						}
						// Choose a greyscale colour with a random element to simulate uneven key pressure and ribbon ink
						var intensity = Math.floor((Math.random() * colour_variation));
						var color = 'rgb(' + intensity + ',' + intensity + ',' + intensity + ')';
						// Random vertical offset
						var voffset = (Math.random() * 2) - 1;
						$('.output').append('<span style="position: relative; top: ' + voffset + 'px; left: -' + (backspaces * 0.6) + 'em; color: ' + color + ';">' + char + '</span>')
						if (x < max_width) {
							x++;
						} else {
							backspaces++; // Fudge hard right margin without position:absolute
						}
					}
					$('.output').animate({
						top: (vmid - (y * 24)) + 'px',
						left: (hmid - (x * 12)) + 'px',
					}, 50);
				}
			}
			$(function() {
				$('.cursor').css('top', vmid + 24).css('left', hmid + 30);
				$.ionSound({
					path: "assets/typewriter_sounds/",
    			sounds: [
        		"typewriter-keydown",
        		"typewriter-keyup",
        		"typewriter-carriage-return",
        		"typewriter-spacebar",
        		"typewriter-bell-2",
    			],
    			multiPlay: true,
				});
				$('.input').val('').trigger('focus')
				.on('blur', function(e) { e.preventDefault(); $(this).trigger('focus'); })
				.on('keydown', function(e) { // I originally used keypress, but this ignores backspace on Chrome
					// Use timeout to regulate maximum typing speed
					clearTimeout(timeout);
    			timeout = setTimeout(function() { 
    				handle_keypress(e); 
    			}, 65);
				})
				.on('keyup', function(e) {
					// Play the key release after a short delay
					setTimeout(function() {
						$.ionSound.play('typewriter-keyup');
					}, 65);
				}); // on()
			}); //$()
		</script>
	</head>
	<body>
		<textarea class="input">
		</textarea>
		<h1 style="margin-bottom: 0">Ben's Super-Realistic* Typewriter Simulator</h1>
		<p style="margin-top: 0"><small>* Neither realism nor superness guaranteed</small></p>
		<div class="info">
			<h2>
				Why?
			</h2>
			<p>
				All the existing typewriter simulators that I've found on the web get one very basic thing wrong - when you press backspace, they erase the character you just typed, just like a computer. On a real typewriter, backspace
				simply moves the carriage back one space, allowing you to overtype a previously typed character; so I have implemented
				it this way. If you want to erase a character, you need Tipp-Ex. (NB I do not advise using Tipp-Ex on your monitor). 
			</p>
			<h2>
				Yeah, but... WHY?
			</h2>
			<p>
				Because it's a fun thing to play with and also an interesting little development project - there's more of a challenge to the implementation than you might expect...
			</p>
			<noscript>
				<p style="font-size: 36px">
					<b>You need to <a href="http://enable-javascript.com">enable Javascript in your browser</a> for this to work.</b>
				</p>
			</noscript>
			<h2>Instructions</h2>
			<div class="instruct">
				<ul>
				<li>Make sure you have your sound turned on for the fully-immersive experience!</li>
				<li>Just start typing (all this informational text will disappear to give you more space).</li>
				<li>Don't click on the page or it may stop working.</li>
				<li>If it stops working just reload the page.</li>
				</ul>
			</div>
			<h2>
				Improvements I'd like to make
			</h2>
			<ul>
				<li>Keep the print head centred and move the whole page left as you type.</li>
				<li>Change the length of the carriage return sound according to the position (ie how far it has to move).</li>
				<li>Get my head round jQuery.Deferred() or similar so that the keyup sound waits for the keydown sound to finish before playing.</li>
				<li>If you type too fast or try to type two keys at once, the mechanism should jam.</li>
				<li>User-adjustable settings for things like ribbon wear.</li>
				<li>Further suggestions welcome (though remember this is just for fun!) to <a href="mailto:ben@uniqcode.com">ben@uniqcode.com</a></li>
			</ul>
			<h2>
				Changelog
			</h2>
			<h3>
				version 1.2 (2014-02-10)
			</h3>
			<ul>
				<li>Don't allow backspacing past the beginning of the line.</li>
			</ul>
			<h3>
				version 1.1 (2014-02-10)
			</h3>
			<ul>
				<li>Separate sounds when keys are pressed and released, and for the shift key.</li>
				<li>Better (manual) carriage return sound.</li>
				<li>Limit the speed at which you can type.</li>
				<li>If you keep typing past the bell and hit the end of the line (80 characters), the carriage stops instead of continuing. In other words there is now a hard line length limit.</li>
				<li>Punctuation characters are handled (these are based on my UK Mac keyboard; unless you have the same keyboard some characters will probably be "wrong" for you.).</li>
				<li>Random variation of colour to simulate variations in key pressure and uneven ribbon ink.</li>
				<li>Hide all the informational text when you start typing, partly to give more space for both information and typing, but mostly to dodge the problem of trying to work out where to position the typewriter output so it doesn't crash the info.</li>
			</ul>
			<h3>
				version 1.0 (2014-02-09)
			</h3>
			
			<p>
				For Archie. Developed by Ben Wheeler @ <a href="http://uniqcode.com">UniqCode</a>, using <a href="http://jquery.com">jQuery</a> and
				<a href="https://github.com/IonDen/ion.sound">IonSound</a>. Typewriter sound effects from <a href="http://freesound.org">Freesound</a> and <a href="http://www.soundjay.com">SoundJay</a>, some of them edited by me. Tested on Firefox27/Mac and Chrome32/Mac. 
			
			</p>
		</div>
		<div class="output">
		</div>
		<div class="cursor">
		</div>
	</body>
</html>